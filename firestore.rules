rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection - users can read/write their own profile
    // Also allow reading other users for admin email lookup
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // Classes collection - teachers can manage their own classes, admins can read/update
    match /classes/{classId} {
      // Owner or admin can read
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.teacherId == request.auth.uid;
      // Owner or admin can update
      allow update: if isAuthenticated();
      // Only owner can delete
      allow delete: if isAuthenticated() &&
        resource.data.teacherId == request.auth.uid;
    }

    // Students collection
    match /students/{studentId} {
      // Teachers can read/manage their own students
      // Parents can read students if they have the studentId in their user profile
      // For simplicity, we allow read if authenticated (parent access is controlled by studentIds in user profile)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.teacherId == request.auth.uid;
      // Teachers can fully update/delete
      // Parents can update the parents array (for accepting invites) - checking via invite existence
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() &&
        resource.data.teacherId == request.auth.uid;
    }

    // Homework collection
    match /homework/{homeworkId} {
      // Teachers can manage homework they created
      // Parents can read homework for their linked students
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        resource.data.teacherId == request.auth.uid;
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      // Teachers can manage attendance they recorded
      // Parents can read attendance for their linked students
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        resource.data.teacherId == request.auth.uid;
    }

    // Invites collection - for parent invitation tracking
    match /invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() &&
        resource.data.teacherId == request.auth.uid;
    }

    // Admin invites collection - for class admin invitation tracking
    match /adminInvites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
  }
}
